name: Test Build Mingw-w64 on Ubuntu(1)

on:
  workflow_dispatch:
    inputs:
      gcc-version:
        description: 'GCC Version'
        required: true
        default: '13.2.0'

jobs:
  build-cross:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install System dependencies
        shell: bash
        run: |
          echo "sudo apt-get update"
          sudo apt-get update 2>&1
          echo "sudo apt-get install -y build-essential autoconf automake libtool pkg-config flex bison texinfo lzma-dev zlib1g-dev nasm libgmp-dev libmpfr-dev libmpc-dev libisl-dev git wget tar xz-utils"
          sudo apt-get install -y \
            build-essential autoconf automake \
            libtool pkg-config flex bison texinfo \
            lzma-dev zlib1g-dev nasm \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            git wget tar xz-utils wine \
            2>&1

      - name: Download Source Code
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          set -euo pipefail
          # load helper functions (assumes scripts/functions.sh is committed)
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          # optional tuning
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${LOG_DIR}"
          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=80
          FAIL_ON_FATAL_IN_SUCCESS=1

          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export MINGW_BASE_URL="https://github.com/mingw-w64/mingw-w64/archive/refs/tags"
          export GNU_BASE_URL="https://ftp.gnu.org/gnu"

          # make base dir
          run "创建源码目录" mkdir -p "${SOURCE_CODE_DIR}"
          run "打印目标目录" echo "Downloading source code to ${SOURCE_CODE_DIR}"

          # 下载源码（每个下载都包装 run）
          run "下载 gcc ${GCC_VERSION}" curl -sSL "${GNU_BASE_URL}/gcc/gcc-${GCC_VERSION}/gcc-${GCC_VERSION}.tar.gz" -o "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz"
          run "下载 binutils 2.40" curl -sSL "${GNU_BASE_URL}/binutils/binutils-2.40.tar.gz" -o "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz"
          run "下载 mingw-w64 v12.0.0" curl -sSL "${MINGW_BASE_URL}/v12.0.0.tar.gz" -o "${SOURCE_CODE_DIR}/mingw-w64-v12.0.0.tar.gz"

          # 解压
          run "解压 gcc" tar -xf "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz" -C "${SOURCE_CODE_DIR}/" && rm -f "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz"
          run "解压 binutils" tar -xf "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz" -C "${SOURCE_CODE_DIR}/" && rm -f "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz"
          run "解压 mingw-w64" tar -xf "${SOURCE_CODE_DIR}/mingw-w64-v12.0.0.tar.gz" -C "${SOURCE_CODE_DIR}/" && rm -f "${SOURCE_CODE_DIR}/mingw-w64-v12.0.0.tar.gz"

          run "整理源码目录名" bash -lc '
            mv "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}" "${SOURCE_CODE_DIR}/gcc"
            mv "${SOURCE_CODE_DIR}/binutils-2.40" "${SOURCE_CODE_DIR}/binutils"
            # the extracted dir name may vary; try common variant:
            if [ -d "${SOURCE_CODE_DIR}/mingw-w64-12.0.0" ]; then
              mv "${SOURCE_CODE_DIR}/mingw-w64-12.0.0" "${SOURCE_CODE_DIR}/mingw-w64"
            elif [ -d "${SOURCE_CODE_DIR}/mingw-w64-v12.0.0" ]; then
              mv "${SOURCE_CODE_DIR}/mingw-w64-v12.0.0" "${SOURCE_CODE_DIR}/mingw-w64"
            fi
          '

          # run contrib/download_prerequisites (wrapped)
          cd "${SOURCE_CODE_DIR}/gcc"
          run "GCC: 下载依赖 (download_prerequisites)" ./contrib/download_prerequisites --directory="${SOURCE_CODE_DIR}"

          # 清理可能存在的依赖目录/压缩包（保持你的逻辑）
          cd "${SOURCE_CODE_DIR}/gcc"
          for d in gmp mpfr mpc isl; do
            if [ -d "${SOURCE_CODE_DIR}/gcc/$d" ]; then
              run "删除 ${SOURCE_CODE_DIR}/gcc/$d" rm -rf "${SOURCE_CODE_DIR}/gcc/$d"
            fi
          done

          cd "${SOURCE_CODE_DIR}"
          for f in gmp-*.tar.* mpfr-*.tar.* mpc-*.tar.* isl-*.tar.*; do
            if [ -f "${SOURCE_CODE_DIR}/$f" ]; then
              run "删除压缩包 ${f}" rm -f "${SOURCE_CODE_DIR}/$f"
            fi
          done

          # 重命名库目录（保留你的现有逻辑）
          cd "${SOURCE_CODE_DIR}"
          for name in gmp mpfr mpc isl; do
            # nullglob for portability in bash (we already source functions.sh so bash is available)
            shopt -s nullglob
            dirs=(${name}-*/)
            shopt -u nullglob

            if [ ${#dirs[@]} -gt 0 ] && [ -d "${dirs[0]}" ]; then
              dir="${dirs[0]%/}"
              run "重命名 ${dir} 为 ${name}" bash -lc "rm -rf \"$name\" 2>/dev/null || true; mv \"${SOURCE_CODE_DIR}/${dir}\" \"${SOURCE_CODE_DIR}/${name}\""
            else
              warn "未找到 ${name}-* 目录"
            fi
          done

          info "下载与解压步骤完成"


      - name: Build cross
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          # tuning
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${LOG_DIR}"
          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=120
          FAIL_ON_FATAL_IN_SUCCESS=1

          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export BUILD_DIR="${GITHUB_WORKSPACE}/build-cross"
          export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-cross"

          # prepare dirs
          for d in "${BUILD_DIR}" "${PREFIX}"; do
            if [ -d "${d}" ]; then
              run "清理目录 ${d}" rm -rf "${d}"
            fi
            run "创建目录 ${d}" mkdir -p "${d}"
          done

          cd "${BUILD_DIR}"

          export BUILD="x86_64-pc-linux-gnu"
          export HOST="x86_64-pc-linux-gnu"
          export TARGET="x86_64-w64-mingw32"

          # binutils
          run "构建 binutils: configure" mkdir -p "${BUILD_DIR}/binutils-build" && cd "${BUILD_DIR}/binutils-build"
          run "binutils: configure" "${SOURCE_CODE_DIR}/binutils/configure" --prefix="${PREFIX}" --target="${TARGET}" --host="${HOST}" --build="${BUILD}" --disable-multilib --disable-werror
          run "binutils: make" make -j$(nproc)
          run "binutils: make install" make install

          export PATH="${PREFIX}/bin:${PATH}"

          # mingw headers
          run "构建 mingw-w64 headers: setup dir" mkdir -p "${BUILD_DIR}/mingw-headers-build" && cd "${BUILD_DIR}/mingw-headers-build"
          run "mingw-headers: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-headers/configure" --prefix="${PREFIX}/${TARGET}" --host="${TARGET}" --build="${BUILD}" --enable-sdk=all --enable-secure-api --enable-idl --disable-multilib
          run "mingw-headers: make" make -j$(nproc)
          run "mingw-headers: install" make install
          run "ls prefix target dir" ls -l "${PREFIX}/${TARGET}/"
          run "ensure mingw include symlink" bash -lc 'mkdir -p "'"${PREFIX}/${TARGET}/mingw"'" && ln -sfn "'"${PREFIX}/${TARGET}/include"'" "'"${PREFIX}/${TARGET}/mingw/include"'"'

          # gcc stage1
          run "准备 gcc stage1 build dir" mkdir -p "${BUILD_DIR}/gcc-stage1-build" && cd "${BUILD_DIR}/gcc-stage1-build"
          run "gcc stage1: configure" "${SOURCE_CODE_DIR}/gcc/configure" \
            --prefix="${PREFIX}" \
            --target="${TARGET}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --disable-multilib \
            --enable-languages=c \
            --without-headers \
            --disable-shared \
            --disable-threads \
            --disable-libatomic \
            --disable-libgomp \
            --disable-libquadmath \
            --disable-libssp \
            --disable-libvtv \
            --disable-libstdcxx \
            --disable-nls \
            --with-gmp=/usr \
            --with-mpfr=/usr \
            --with-mpc=/usr \
            --with-isl=/usr

          run "gcc stage1: make all-gcc" make -j$(nproc) all-gcc
          run "gcc stage1: install-gcc" make install-gcc

          # set cross toolchain env
          export CC="${PREFIX}/bin/${TARGET}-gcc"
          export CXX="${PREFIX}/bin/${TARGET}-g++"
          export LD="${PREFIX}/bin/${TARGET}-ld"
          export AR="${PREFIX}/bin/${TARGET}-ar"
          export AS="${PREFIX}/bin/${TARGET}-as"
          export RANLIB="${PREFIX}/bin/${TARGET}-ranlib"

          # mingw-crt
          run "prepare mingw-crt build dir" mkdir -p "${BUILD_DIR}/mingw-crt-build" && cd "${BUILD_DIR}/mingw-crt-build"
          run "mingw-crt: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-crt/configure" --prefix="${PREFIX}/${TARGET}" --host="${TARGET}" --build="${BUILD}" --disable-multilib --with-sysroot="${PREFIX}/${TARGET}"
          run "mingw-crt: make" make -j$(nproc)
          run "mingw-crt: install" make install

          # gcc full build
          run "取消 cross 工具链环境变量" unset CC CXX LD AR AS RANLIB
          run "准备 gcc full build dir" mkdir -p "${BUILD_DIR}/gcc-full-build" && cd "${BUILD_DIR}/gcc-full-build"
          run "gcc full: configure" "${SOURCE_CODE_DIR}/gcc/configure" \
            --prefix="${PREFIX}" \
            --target="${TARGET}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --disable-multilib \
            --enable-languages=c,c++ \
            --enable-threads=win32 \
            --enable-shared \
            --enable-static \
            --with-sysroot="${PREFIX}/${TARGET}" \
            --disable-nls \
            --with-gmp=/usr \
            --with-mpfr=/usr \
            --with-mpc=/usr \
            --with-isl=/usr

          export CC="${PREFIX}/bin/${TARGET}-gcc"
          export CXX="${PREFIX}/bin/${TARGET}-g++"
          export LD="${PREFIX}/bin/${TARGET}-ld"
          export AR="${PREFIX}/bin/${TARGET}-ar"
          export AS="${PREFIX}/bin/${TARGET}-as"
          export RANLIB="${PREFIX}/bin/${TARGET}-ranlib"

          run "gcc full: make" make -j$(nproc)
          run "gcc full: install" make install

          # 最后：生成聚合 summary 并打印路径（actions 后续可上传）
          agg="$(aggregate_all_summaries)"
          info "聚合摘要已写入：$agg"


      - name: verify cross compiler
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-cross"
          export TARGET="x86_64-w64-mingw32"

          ls "${PREFIX}/bin/"

          echo "验证交叉编译器"
          "${PREFIX}/bin/${TARGET}-gcc" --version
          "${PREFIX}/bin/${TARGET}-g++" --version

          echo -e "\n7.3 编译简单的C程序（验证生成Windows PE文件）"
          cat > test-cross.c << 'EOF'
          #include <stdio.h>
          int main() {
              printf("Hello from cross-compiler! This is a Windows executable.\n");
              return 0;
          }
          EOF

          # 使用交叉编译器编译
          "${PREFIX}/bin/${TARGET}-gcc" test-cross.c -o test-cross.exe

          echo "检查生成的文件类型："
          file test-cross.exe || true
          echo "文件应显示为 'PE32+ executable (console) x86-64, for MS Windows'"

          # 在Linux上不能运行这个.exe，但可以检查文件是否存在
          if [ -f "test-cross.exe" ]; then
              echo "✓ 成功生成了Windows可执行文件"
              ls -lh test-cross.exe
          else
              echo "✗ 未能生成可执行文件"
              exit 1
          fi

          echo -e "\n7.4 编译C++程序（验证C++支持）"
          cat > test-cross.cpp << 'EOF'
          #include <iostream>
          int main() {
              std::cout << "Hello from C++ cross-compiler!" << std::endl;
              return 0;
          }
          EOF

          "${PREFIX}/bin/${TARGET}-g++" test-cross.cpp -o test-cross-cpp.exe

          echo "检查C++生成的文件类型："
          file test-cross-cpp.exe || true

          echo -e "\n7.5 验证链接到mingw-w64库"
          cat > test-windows.c << 'EOF'
          #include <windows.h>
          #include <stdio.h>
          int main() {
              MessageBoxA(NULL, "Hello from Windows API!", "Test", MB_OK);
              printf("Message box should have appeared (if run on Windows)\n");
              return 0;
          }
          EOF

          "${PREFIX}/bin/${TARGET}-gcc" test-windows.c -o test-windows.exe \
            -Wl,--subsystem,windows

          echo "检查Windows GUI程序："
          file test-windows.exe || true

          echo -e "\n7.6 清理测试文件"
          rm -f test-cross.c test-cross.cpp test-windows.c \
                test-cross.exe test-cross-cpp.exe test-windows.exe

      # - name: Build native
      #   shell: bash
      #   env:
      #     GITHUB_WORKSPACE: ${{ github.workspace }}
      #     GCC_VERSION: ${{ github.event.inputs.gcc-version }}
      #   run: |
      #     export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
      #     export BUILD_DIR="${GITHUB_WORKSPACE}/build-native"
      #     export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-native"

      #     for d in ${BUILD_DIR} "${PREFIX}"; do
      #       if [ -d "${d}" ]; then
      #         echo "删除目录 ${d}"
      #         rm -rf "${d}"
      #       fi
      #       echo "创建目录 ${d}"
      #       mkdir -p "${d}"
      #     done
      #     cd "${BUILD_DIR}"

      #     # cross三元组
      #     export BUILD="x86_64-pc-linux-gnu"
      #     export HOST="x86_64-w64-mingw32"
      #     export TARGET="x86_64-w64-mingw32"

      #     echo "构建 binutils"



      #     echo "构建gmp mpfr mpc isl"
      #     mkdir -p "${BUILD_DIR}/gmp-build" "${BUILD_DIR}/mpfr-build" "${BUILD_DIR}/mpc-build" "${BUILD_DIR}/isl-build"
      #     cd "${BUILD_DIR}/gmp-build"
      #     "${SOURCE_CODE_DIR}/gmp/configure" \
      #       --prefix="${PREFIX}" \
      #       --host="${HOST}" \
      #       --build="${BUILD}" \
      #       --enable-static \
      #       --disable-shared
      #     make -j$(nproc)
      #     make install
      #     cd "${BUILD_DIR}/mpfr-build"
      #     "${SOURCE_CODE_DIR}/mpfr/configure" \
      #       --prefix="${PREFIX}" \
      #       --host="${HOST}" \
      #       --build="${BUILD}" \
      #       --with-gmp="${PREFIX}" \
      #       --enable-static \
      #       --disable-shared
      #     make -j$(nproc)
      #     make install
      #     cd "${BUILD_DIR}/mpc-build"
      #     "${SOURCE_CODE_DIR}/mpc/configure" \
      #       --prefix="${PREFIX}" \
      #       --host="${HOST}" \
      #       --build="${BUILD}" \
      #       --with-gmp="${PREFIX}" \
      #       --with-mpfr="${PREFIX}" \
      #       --enable-static \
      #       --disable-shared
      #     make -j$(nproc)
      #     make install
      #     cd "${BUILD_DIR}/isl-build"
      #     "${SOURCE_CODE_DIR}/isl/configure" \
      #       --prefix="${PREFIX}" \
      #       --host="${HOST}" \
      #       --build="${BUILD}" \
      #       --with-gmp-prefix="${PREFIX}" \
      #       --enable-static \
      #       --disable-shared
      #     make -j$(nproc)
      #     make install


