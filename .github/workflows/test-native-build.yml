name: Test Native Build Mingw-w64 on Ubuntu(2)

on:
  workflow_dispatch:
    inputs:
      gcc-version:
        description: 'GCC Version'
        required: true
        default: '13.2.0'

jobs:
  build-cross:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install System dependencies
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          FORCE_COLOR: '1'
        run: |
          set -euo pipefail

          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${LOG_DIR}"
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          info "开始安装系统依赖（apt-get）"
          export DEBIAN_FRONTEND=noninteractive

          run "apt-get update" sudo apt-get update

          pkgs=( build-essential automake gettext autopoint pkg-config autoconf autoconf-archive libtool m4 liblzma-dev nasm libgmp-dev libmpfr-dev libmpc-dev libisl-dev zlib1g-dev python3 python3-dev tcl tcl-dev )

          for p in "${pkgs[@]}"; do
            install_pkg "安装${p}包" "$p"
          done

          info "系统依赖安装完成"

      - name: Download Source Code
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
          LOG_DIR: "${{ github.workspace }}/logs"
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          info "GCC 版本: ${GCC_VERSION}"
          DEP_JSON_FILE="${GITHUB_WORKSPACE}/dependencies.json"
          run "获取组件版本信息" export_versions_from_json "${DEP_JSON_FILE}" "${GCC_VERSION}" local

          export GITHUB_BASE_URL="https://github.com"
          export GNU_BASE_URL="https://ftp.gnu.org/gnu"
          SQLITE_BASE_URL="https://sqlite.org"

          # optional tuning
          export FORCE_COLOR=1
          mkdir -p "${LOG_DIR}"
          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=80
          FAIL_ON_FATAL_IN_SUCCESS=1

          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code" && mkdir -p "${SOURCE_CODE_DIR}"

          gnu_pkgs=( gcc binutils libiconv ncurses readline gdbm )
          github_pkgs=( mingw-w64 zlib xz openssl libffi expat bzip2 )

          for p in "${gnu_pkgs[@]}";do
            if [[ "${p}" == "gcc" ]]; then
              ver="${GCC_VERSION}"
              echo "下载${p} 源码版本: ${ver}"
              run "下载${p}-${ver} 源码" curl_download "${GNU_BASE_URL}/${p}/${p}-${ver}/${p}-${ver}.tar.gz" "${SOURCE_CODE_DIR}"
              run "解压${p}-${ver} 源码" archive_extract "${p}" "${SOURCE_CODE_DIR}/${p}-${ver}.tar.gz" "${SOURCE_CODE_DIR}"
              # for d in gcc gmp mpfr mpc isl; do
              #   du -sh "${SOURCE_CODE_DIR}/${d}"
              # done
            else
              val="$(echo "$p" | tr '[:lower:]' '[:upper:]')"
              ver=${!val}
              run "下载${p}-${ver} 源码" curl_download "${GNU_BASE_URL}/${p}/${p}-${ver}.tar.gz" "${SOURCE_CODE_DIR}"
              run "解压${p}-${ver} 源码" archive_extract "${p}" "${SOURCE_CODE_DIR}/${p}-${ver}.tar.gz" "${SOURCE_CODE_DIR}"
              # du -sh "${SOURCE_CODE_DIR}/${p}"
            fi
          done
          for p in "${github_pkgs[@]}";do
            case "${p}" in
              mingw-w64)
                ver="${MINGW_W64}"
                github_author="mingw-w64"
                project_name="mingw-w64"
                ;;
              zlib)
                ver="${ZLIB}"
                github_author="madler"
                project_name="zlib"
                ;;
              xz)
                ver="${XZ}"
                github_author="tukaani-project"
                project_name="xz"
                ;;
              openssl|libffi)
                pkg_name=${p^^}
                ver="${!pkg_name}"
                github_author="${p}"
                project_name="${p}"
                ;;
              expat)
                ver="${EXPAT}"
                github_author="libexpat"
                project_name="libexpat"
                ;;
              bzip2)
                ver="${BZIP2_VER}"
                github_author="RiverBreaker"
                project_name="bzip2-autoconf"
                ;;
              *)
                error "未知的 GitHub 包: ${p}"
                exit 1
                ;;
            esac
            if [[ "${p}" == "expat" ]] || [[ "${p}" == "libffi" ]] || [[ "${p}" == "openssl" ]] || [[ "${p}" == "xz" ]]; then
              tail="${p}-${ver}.tar.gz"
            elif [[ "${p}" == "bzip2" ]]; then
              tail="${p}-autoconf-${ver}.tar.gz"
            else
              tail="v${ver}.tar.gz" # cpython-mingw zlib ninja
            fi
            if [[ "${p}" == "libffi" ]] || [[ "${p}" == "xz" ]]; then
              TAG="v${ver}"
              URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/releases/download/${TAG}/${tail}"
            elif [[ "${p}" == "expat" ]]; then
              EXPAT_TAG="R_${ver//./_}"
              URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/releases/download/${EXPAT_TAG}/${tail}"
            else
              URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/archive/refs/tags/${tail}"
            fi
            run "下载${p}-${ver} 源码" curl_download "${URL}" "${SOURCE_CODE_DIR}"
            run "解压${p}-${ver} 源码" archive_extract "${p}" "${SOURCE_CODE_DIR}/${tail}" "${SOURCE_CODE_DIR}"
          done
          run "下载 sqlite 源码" curl_download "${SQLITE_BASE_URL}/${SQLITE_YEAR}/sqlite-autoconf-${SQLITE_VERSION}.tar.gz" "${SOURCE_CODE_DIR}"
          run "解压 sqlite 源码" archive_extract sqlite "${SOURCE_CODE_DIR}/sqlite-autoconf-${SQLITE_VERSION}.tar.gz" "${SOURCE_CODE_DIR}"
          run "git clone cpython-mingw source code" git clone -b mingw-v${PYTHON} https://github.com/msys2-contrib/cpython-mingw.git "${SOURCE_CODE_DIR}/python"
          info "下载与解压步骤完成"

      - name: Build cross
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          # tuning
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          export FORCE_COLOR=1
          mkdir -p "${LOG_DIR}"
          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=120
          FAIL_ON_FATAL_IN_SUCCESS=1

          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export BUILD_DIR="${GITHUB_WORKSPACE}/build-cross"
          export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-cross"

          # prepare dirs
          for d in "${BUILD_DIR}" "${PREFIX}"; do
            if [ -d "${d}" ]; then
              run "清理目录 ${d}" rm -rf "${d}"
            fi
            run "创建目录 ${d}" mkdir -p "${d}"
          done

          cd "${BUILD_DIR}"

          export BUILD="x86_64-pc-linux-gnu"
          export HOST="x86_64-pc-linux-gnu"
          export TARGET="x86_64-w64-mingw32"

          pkgs=( binutils libiconv make termcap ncurses readline gdbm gdb python openssl sqlite ninja cmake libffi pkgconf expat )
          info "准备清理环境变量"
          for p in "${pkgs[@]}"; do
            val="$(echo "$p" | tr '[:lower:]' '[:upper:]')"
            unset "${val}"
          done
          unset MINGW_W64 gcc_version

          # binutils
          run "构建 binutils: configure" mkdir -p "${BUILD_DIR}/binutils-build"
          cd "${BUILD_DIR}/binutils-build"
          run "binutils: configure" "${SOURCE_CODE_DIR}/binutils/configure" \
            --prefix="${PREFIX}" \
            --target="${TARGET}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --disable-multilib \
            --disable-werror
          run "binutils: make" make -j$(nproc)
          run "binutils: make install" make install

          export PATH="${PREFIX}/bin:${PATH}"

          # mingw headers
          run "构建 mingw-w64 headers: setup dir" mkdir -p "${BUILD_DIR}/mingw-headers-build"
          cd "${BUILD_DIR}/mingw-headers-build"
          run "mingw-headers: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-headers/configure" --prefix="${PREFIX}/${TARGET}" --host="${TARGET}" --build="${BUILD}" --enable-sdk=all --enable-secure-api --enable-idl --disable-multilib
          run "mingw-headers: make" make -j$(nproc)
          run "mingw-headers: install" make install
          run "ls prefix target dir" ls -l "${PREFIX}/${TARGET}/"
          run "ensure mingw include symlink" bash -lc 'mkdir -p "'"${PREFIX}/${TARGET}/mingw"'" && ln -sfn "'"${PREFIX}/${TARGET}/include"'" "'"${PREFIX}/${TARGET}/mingw/include"'"'

          # gcc stage1
          run "准备 gcc stage1 build dir" mkdir -p "${BUILD_DIR}/gcc-stage1-build"
          cd "${BUILD_DIR}/gcc-stage1-build"
          run "gcc stage1: configure" "${SOURCE_CODE_DIR}/gcc/configure" \
            --prefix="${PREFIX}" \
            --target="${TARGET}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --disable-multilib \
            --enable-languages=c \
            --without-headers \
            --disable-shared \
            --disable-threads \
            --disable-libatomic \
            --disable-libgomp \
            --disable-libquadmath \
            --disable-libssp \
            --disable-libvtv \
            --disable-libstdcxx \
            --disable-nls \
            --with-gmp=/usr \
            --with-mpfr=/usr \
            --with-mpc=/usr \
            --with-isl=/usr

          run "gcc stage1: make all-gcc" make -j$(nproc) all-gcc
          run "gcc stage1: install-gcc" make install-gcc

          # mingw-crt
          run "prepare mingw-crt build dir" mkdir -p "${BUILD_DIR}/mingw-crt-build"
          cd "${BUILD_DIR}/mingw-crt-build"
          run "mingw-crt: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-crt/configure" --prefix="${PREFIX}/${TARGET}" --host="${TARGET}" --build="${BUILD}" --disable-multilib --with-sysroot="${PREFIX}/${TARGET}"
          run "mingw-crt: make" make -j$(nproc)
          run "mingw-crt: install" make install

          # gcc full build
          # set cross toolchain env
          export CC="gcc"
          export CXX="g++"
          export LD="ld"
          export AR="ar"
          export AS="as"
          export RANLIB="ranlib"
          run "准备 gcc full build dir" mkdir -p "${BUILD_DIR}/gcc-full-build"
          cd "${BUILD_DIR}/gcc-full-build"
          run "gcc full: configure" "${SOURCE_CODE_DIR}/gcc/configure" \
            --prefix="${PREFIX}" \
            --target="${TARGET}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --disable-multilib \
            --enable-languages=c,c++,fortran \
            --enable-threads=win32 \
            --enable-shared \
            --enable-static \
            --with-sysroot="${PREFIX}/${TARGET}" \
            --disable-nls \
            --with-gmp=/usr \
            --with-mpfr=/usr \
            --with-mpc=/usr \
            --with-isl=/usr

          # set cross toolchain env
          export CC="${PREFIX}/bin/${TARGET}-gcc"
          export CXX="${PREFIX}/bin/${TARGET}-g++"
          export LD="${PREFIX}/bin/${TARGET}-ld"
          export AR="${PREFIX}/bin/${TARGET}-ar"
          export AS="${PREFIX}/bin/${TARGET}-as"
          export RANLIB="${PREFIX}/bin/${TARGET}-ranlib"
          run "gcc full: make" make -j$(nproc)
          run "gcc full: install" make install

          info "交叉编译工具链构建完成！"
          info "工具链已安装到：${PREFIX}"
          run "清除构建目录以节省空间" rm -rf "${BUILD_DIR}"

          # 最后：生成聚合 summary 并打印路径（actions 后续可上传）
          agg="$(aggregate_all_summaries)"
          info "聚合摘要已写入：$agg"

      - name: Build native
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          # params / tuning
          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export BUILD_DIR="${GITHUB_WORKSPACE}/build-native"
          export CROSS_PREFIX="${GITHUB_WORKSPACE}/mingw-w64-cross"
          export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-native"
          # export POSIX_DIR="${GITHUB_WORKSPACE}/winpthreads"

          export BUILD="x86_64-pc-linux-gnu"
          export HOST="x86_64-w64-mingw32"
          export TARGET="x86_64-w64-mingw32"

          # 定义子目录
          export OPT_DIR="${PREFIX}/opt"
          export TARGET_DIR="${PREFIX}/${TARGET}"
          export SHARE_DIR="${PREFIX}/share"

          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          export FORCE_COLOR=1
          mkdir -p "${LOG_DIR}"

          export CFLAGS="-O2 -pipe -fno-ident"
          export CXXFLAGS="${CFLAGS}"
          export LDFLAGS="-pipe -fno-ident"
          export CPPFLAGS=""

          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=300
          FAIL_ON_FATAL_IN_SUCCESS=1

          # 创建所有必要的目录
          for d in "${BUILD_DIR}" "${PREFIX}" "${OPT_DIR}" "${SHARE_DIR}" "${TARGET_DIR}"; do
            if [ -d "${d}" ]; then
              run "清理目录 ${d}" rm -rf "${d}"
            fi
            run "创建目录 ${d}" mkdir -p "${d}"
          done

          cd "${BUILD_DIR}"

          # triples and PATH (use cross toolchain to build mingw-native artifacts)
          export PATH="${CROSS_PREFIX}/bin:${PATH}"

          # 工具链编译器
          export CC="${CROSS_PREFIX}/bin/${TARGET}-gcc"
          export CXX="${CROSS_PREFIX}/bin/${TARGET}-g++"
          export LD="${CROSS_PREFIX}/bin/${TARGET}-ld"
          export AR="${CROSS_PREFIX}/bin/${TARGET}-ar"
          export AS="${CROSS_PREFIX}/bin/${TARGET}-as"
          export RANLIB="${CROSS_PREFIX}/bin/${TARGET}-ranlib"
          export STRIP="${CROSS_PREFIX}/bin/${TARGET}-strip"
          export WINDRES="${CROSS_PREFIX}/bin/${TARGET}-windres"
          export FC="${CROSS_PREFIX}/bin/${TARGET}-gfortran"

          # =========== 2. libiconv (安装到 ${PREFIX}) ===========
          # libiconv (Windows原生版本)
          run "准备 libiconv build dir" mkdir -p "${BUILD_DIR}/libiconv-build"
          cd "${BUILD_DIR}/libiconv-build"
          run "libiconv: configure" "${SOURCE_CODE_DIR}/libiconv/configure" \
            --prefix="${TARGET_DIR}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --enable-static \
            --disable-shared \
            --disable-nls \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"
          run "libiconv: make" make -j$(nproc)
          run "libiconv: make install" make install

          # =========== build zlib static ======================
          run "准备 zlib build dir" mkdir -p "${BUILD_DIR}/zlib-build"
          cd "${BUILD_DIR}/zlib-build"
          run "zlib: configure" "${SOURCE_CODE_DIR}/zlib/configure" \
            --prefix="${OPT_DIR}" \
            --static
          run "zlib: make" make -j$(nproc)
          run "zlib: make install" make install

          export CFLAGS="${CFLAGS} -I${OPT_DIR}/include"
          export CXXFLAGS="${CXXFLAGS} -I${OPT_DIR}/include"
          export LDFLAGS="${LDFLAGS} -L${OPT_DIR}/lib"
          export CPPFLAGS="${CPPFLAGS} -I${OPT_DIR}/include"

          # 这些是gcc的直接依赖，需要安装在主目录
          for d in gmp mpfr mpc isl; do
            run "准备 ${d} build dir" mkdir -p "${BUILD_DIR}/${d}-build"
            cd "${BUILD_DIR}/${d}-build"

            DEP_FLAGS=""
            if [[ "$d" == "mpfr" ]]; then
              DEP_FLAGS="--with-gmp=${PREFIX}"
            elif [[ "$d" == "mpc" ]]; then
              DEP_FLAGS="--with-gmp=${PREFIX} --with-mpfr=${PREFIX}"
            elif [[ "$d" == "isl" ]]; then
              DEP_FLAGS="--with-gmp-prefix=${PREFIX}"
            fi

            run "${d}: configure" "${SOURCE_CODE_DIR}/${d}/configure" \
              --prefix="${PREFIX}" \
              --host="${HOST}" \
              --build="${BUILD}" \
              ${DEP_FLAGS} \
              --enable-static \
              --disable-shared \
              CFLAGS="${CFLAGS}" \
              CXXFLAGS="${CXXFLAGS}" \
              LDFLAGS="${LDFLAGS}" \
              CPPFLAGS="${CPPFLAGS}"

            run "${d}: make" make -j$(nproc)
            run "${d}: make install" make install
          done

          # =========== 3. mingw-w64 头文件 (安装到 ${TARGET_DIR}) ===========
          run "准备 mingw-headers build dir" mkdir -p "${BUILD_DIR}/mingw-headers-build"
          cd "${BUILD_DIR}/mingw-headers-build"
          run "mingw-headers: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-headers/configure" \
            --prefix="${TARGET_DIR}" \
            --host="${TARGET}" \
            --build="${BUILD}" \
            --enable-sdk=all \
            --enable-secure-api \
            --enable-idl \
            --disable-multilib \
            --with-default-msvcrt=ucrt \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"
          run "mingw-headers: make" make -j$(nproc)
          run "mingw-headers: install" make install

          # ensure include symlink
          run "ensure mingw include symlink" bash -lc 'mkdir -p "'"${TARGET_DIR}/mingw"'" && ln -sfn "'"${TARGET_DIR}/include"'" "'"${TARGET_DIR}/mingw/include"'"'

           # =========== 5. mingw-w64 CRT (安装到 ${TARGET_DIR}) ===========
          run "准备 mingw-crt build dir" mkdir -p "${BUILD_DIR}/mingw-crt-build"
          cd "${BUILD_DIR}/mingw-crt-build"
          run "mingw-crt: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-crt/configure" \
            --prefix="${TARGET_DIR}" \
            --host="${TARGET}" \
            --build="${BUILD}" \
            --with-sysroot="${TARGET_DIR}" \
            --disable-multilib \
            --with-default-msvcrt=ucrt \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"
          run "mingw-crt: make" make -j$(nproc)
          run "mingw-crt: install" make install

          # =========== mingw-w64-winpthreads =================
          run "准备 mingw-w64-winpthreads build dir" mkdir -p "${BUILD_DIR}/mingw-w64-winpthreads-build"
          cd "${BUILD_DIR}/mingw-w64-winpthreads-build"
          run "mingw-w64-winpthreads: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-libraries/winpthreads/configure" \
            --prefix="${TARGET_DIR}" \
            --host="${TARGET}" \
            --build="${BUILD}" \
            --with-sysroot="${TARGET_DIR}" \
            --enable-static \
            --enable-shared \
            --disable-multilib \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"

          run "mingw-w64-winpthreads: make" make -j$(nproc)
          run "mingw-w64-winpthreads: install" make install

          # =========== 2. binutils (安装到 ${PREFIX}) ===========
          run "准备 binutils build dir" mkdir -p "${BUILD_DIR}/binutils-build"
          cd "${BUILD_DIR}/binutils-build"
          run "binutils: configure" "${SOURCE_CODE_DIR}/binutils/configure" \
            --prefix="${PREFIX}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --target="${TARGET}" \
            --disable-werror \
            --enable-lto \
            --enable-plugins \
            --with-sysroot="${TARGET_DIR}" \
            --enable-install-libiberty \
            --disable-nls \
            --disable-rpath \
            --enable-host-shared=no \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"
          run "binutils: make" make -j$(nproc)
          run "binutils: make install" make install

          # =========== 12. mingw-w64 其他库 ===========
          # libmangle (安装到 ${TARGET_DIR})
          run "准备 mingw-w64-libmangle build dir" mkdir -p "${BUILD_DIR}/mingw-w64-libmangle-build"
          cd "${BUILD_DIR}/mingw-w64-libmangle-build"
          run "mingw-w64-libmangle: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-libraries/libmangle/configure" \
            --prefix="${TARGET_DIR}" \
            --host="${TARGET}" \
            --build="${BUILD}" \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"
          run "mingw-w64-libmangle: make" make -j$(nproc)
          run "mingw-w64-libmangle: install" make install

          # tools (包含 widl 等工具，安装到 ${PREFIX})
          for p in gendef genidl genpeimg widl; do
            run "准备 mingw-w64-tools ${p} build dir" mkdir -p "${BUILD_DIR}/mingw-w64-tools-${p}-build"
            cd "${BUILD_DIR}/mingw-w64-tools-${p}-build"
            run "mingw-w64-tools: configure" "${SOURCE_CODE_DIR}/mingw-w64/mingw-w64-tools/${p}/configure" \
              --prefix="${PREFIX}" \
              --host="${HOST}" \
              --build="${BUILD}" \
              --with-sysroot="${TARGET_DIR}" \
              CFLAGS="${CFLAGS}" \
              CXXFLAGS="${CXXFLAGS}" \
              LDFLAGS="${LDFLAGS}" \
              CPPFLAGS="${CPPFLAGS}"
            run "mingw-w64-tools ${p} : make" make -j$(nproc)
            run "mingw-w64-tools ${p} : install" make install
          done

          # =========== 13. gcc 第二阶段 (完整版本) ===========
          run "恢复使用新构建的binutils" export PATH="${PREFIX}/bin:${PATH}"
          run "准备 gcc stage2 build dir" mkdir -p "${BUILD_DIR}/gcc2-build"
          cd "${BUILD_DIR}/gcc2-build"
          # info "取消 cross 工具链环境变量"
          # unset CC CXX LD AR AS RANLIB
          run "gcc stage2: configure" "${SOURCE_CODE_DIR}/gcc/configure" \
            --prefix="${PREFIX}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --target="${TARGET}" \
            --enable-languages=c,c++,fortran \
            --enable-shared \
            --enable-static \
            --enable-threads=win32 \
            --enable-lto \
            --enable-plugins \
            --with-default-msvcrt=ucrt \
            --disable-nls \
            --disable-multilib \
            --with-gmp="${PREFIX}" \
            --with-mpfr="${PREFIX}" \
            --with-mpc="${PREFIX}" \
            --with-isl="${PREFIX}" \
            --with-system-zlib \
            --with-sysroot="${TARGET_DIR}" \
            --with-boot-ldflags="-Wl,--disable-dynamicbase -static-libstdc++ -static-libgcc" \
            CFLAGS="${CFLAGS}" \
            CXXFLAGS="${CXXFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            CPPFLAGS="${CPPFLAGS}"

          run "gcc stage2: make" make -j$(nproc)
          run "gcc stage2: make install" make install-strip
          cp "${TARGET_DIR}/bin/libwinpthread-1.dll" "${PREFIX}/bin"

          export BASE_CFLAGS="-O2 -pipe -fno-ident -I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_CXXFLAGS="-O2 -pipe -fno-ident -I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_CPPFLAGS="-I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_LDFLAGS="-L${TARGET_DIR}/lib -L${OPT_DIR}/lib"

          # bzip2
          run "bzip2 build dir" mkdir -p "${BUILD_DIR}/bzip2-build"
          cd "${BUILD_DIR}/bzip2-build"
          run "bzip2 configure" "${SOURCE_CODE_DIR}/bzip2/configure" \
          --build="${BUILD}" \
          --host="${HOST}" \
          --target="${HOST}" \
          --prefix="${OPT_DIR}" \
          --disable-shared \
          --enable-static \
          CFLAGS="${BASE_CFLAGS}" \
          CXXFLAGS="${BASE_CXXFLAGS}" \
          CPPFLAGS="${BASE_CPPFLAGS}" \
          LDFLAGS="${BASE_LDFLAGS}"
          run "bzip2 make" make -j$(nproc)
          run "bzip2 install" make install

          # ============ libffi
          run "准备 libffi build dir" mkdir -p "${BUILD_DIR}/libffi-build"
          cd "${BUILD_DIR}/libffi-build"
          run "libffi configure" "${SOURCE_CODE_DIR}/libffi/configure" \
            --prefix="${OPT_DIR}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --target="${TARGET}" \
            --enable-shared --disable-static \
              CFLAGS="${BASE_CFLAGS}" \
              CXXFLAGS="${BASE_CXXFLAGS}" \
              CPPFLAGS="${BASE_CPPFLAGS}" \
              LDFLAGS="${BASE_LDFLAGS}"
          run "libffi make" make -j$(nproc)
          run "libffig make install" make install

          # =========== 构建expat
          run "准备 expat build dir" mkdir -p "${BUILD_DIR}/expat-build"
          cd "${BUILD_DIR}/expat-build"
          run "expat: configure" "${SOURCE_CODE_DIR}/expat/configure" \
            --prefix="${OPT_DIR}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --enable-static \
            --disable-shared \
            --without-docbook \
            --without-xmlwf \
            CFLAGS="${BASE_CFLAGS}" \
            CXXFLAGS="${BASE_CXXFLAGS}" \
            CPPFLAGS="${BASE_CPPFLAGS}" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "expat: make" make -j$(nproc)
          run "expat: make install" make install

          # =========== 构建ncurses
          run "准备 ncurses build dir" mkdir -p "${BUILD_DIR}/ncurses-build"
          cd "${BUILD_DIR}/ncurses-build"
          run "ncurses: configure" "${SOURCE_CODE_DIR}/ncurses/configure" \
            --prefix="${OPT_DIR}" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --without-ada --with-cxx \
            --without-pthread --enable-pc-files \
            --with-pkg-config \
            --with-pkg-config-libdir=${OPT_DIR}/lib/pkgconfig \
            --disable-rpath --enable-colorfgbg \
            --disable-symlinks --enable-warnings \
            --enable-assertions --disable-home-terminfo \
            --enable-database --enable-sp-funcs \
            --enable-term-driver --enable-interop --enable-widec --without-trace \
            CFLAGS="${BASE_CFLAGS} -D__USE_MINGW_ACCESS" \
            CXXFLAGS="${BASE_CXXFLAGS}" \
            CPPFLAGS="${BASE_CPPFLAGS} " \
            LDFLAGS="${BASE_LDFLAGS}"

          run "ncurses: make" make -j$(nproc)
          run "ncurses: make install" make install

          # readline
          run "准备 readline build dir" mkdir -p "${BUILD_DIR}/readline-build"
          cd ${SOURCE_CODE_DIR}/readline && patch -p1 < "${GITHUB_WORKSPACE}/patches/readline-8.2-fix-mingw32.patch"
          cd "${BUILD_DIR}/readline-build"
          run "readline configure" "${SOURCE_CODE_DIR}/readline/configure" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --target="${TARGET}" \
            --prefix="${OPT_DIR}" --disable-shared --enable-static --without-curses \
            CFLAGS="${BASE_CFLAGS} -D__USE_MINGW_ANSI_STDIO=1 -fcommon -DNCURSES_STATIC -D_WIN32_WINNT=0x0600" \
            CXXFLAGS="${BASE_CXXFLAGS} -DNCURSES_STATIC -D_WIN32_WINNT=0x0600" \
            CPPFLAGS="${BASE_CPPFLAGS} -DNCURSES_STATIC -D_WIN32_WINNT=0x0600" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "readline make" make -j$(nproc)
          run "readline make install" make install

          # gdbm
          run "gdbm build dir mk" mkdir -p "${BUILD_DIR}/gdbm-build"
          cd ${SOURCE_CODE_DIR}/gdbm && patch -p1 < "${GITHUB_WORKSPACE}/patches/gdbm-fix-support-win32.patch"
          autoreconf -fi
          cd "${BUILD_DIR}/gdbm-build"
          run "gdbm configure" "${SOURCE_CODE_DIR}/gdbm/configure" \
            --host="${HOST}" \
            --build="${BUILD}" \
            --target="${TARGET}" \
            --prefix="${OPT_DIR}" --disable-shared --enable-static --enable-libgdbm-compat \
            CFLAGS="${BASE_CFLAGS} -fcommon" \
            CXXFLAGS="${BASE_CXXFLAGS}" \
            CPPFLAGS="${BASE_CPPFLAGS}" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "gdbm make" make -j$(nproc)
          run "gdbm make install" make install

          #openssl
          run "openssl build dir mk" mkdir -p "${BUILD_DIR}/openssl-build"
          cd "${BUILD_DIR}/openssl-build"
          run "openssl configure" "${SOURCE_CODE_DIR}/openssl/Configure" \
            --prefix="${OPT_DIR}" \
            --libdir="${OPT_DIR}/lib" \
            --openssldir="${OPT_DIR}/ssl" \
            --with-zlib-include="${OPT_DIR}/include" \
            --with-zlib-lib="${OPT_DIR}/lib" \
            shared \
            threads \
            zlib \
            enable-camellia enable-capieng \
            enable-idea enable-mdc2 enable-rc5 \
            enable-rfc3779 -D__MINGW_USE_VC2005_COMPAT \
            -DOPENSSLBIN="${OPT_DIR}/bin" \
            mingw64
          run "openssl make" make -j$(nproc)
          run "openssl make install" make install

          #xz
          run "xz build dir" mkdir -p "${BUILD_DIR}/xz-build"
          cd "${BUILD_DIR}/xz-build"
          run "xz configure" "${SOURCE_CODE_DIR}/xz/configure" \
            --build="${BUILD}" \
            --host="${HOST}" \
            --target="${TARGET}" \
            --prefix="${OPT_DIR}" \
            --enable-static --disable-shared \
            --disable-rpath --disable-lzma-links \
            CFLAGS="${BASE_CFLAGS}" \
            CXXFLAGS="${BASE_CXXFLAGS}" \
            CPPFLAGS="${BASE_CPPFLAGS}" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "xz make" make -j$(nproc)
          run "xz make install" make install

          #sqlite
          run "准备sqlite build dir" mkdir -p "${BUILD_DIR}/sqlite-build"
          cd "${BUILD_DIR}/sqlite-build"
          run "sqlite configure" "${SOURCE_CODE_DIR}/sqlite/configure" \
            --build="${BUILD}" \
            --host="${HOST}" \
            --target="${TARGET}" \
            --prefix="${OPT_DIR}" \
            --enable-threadsafe \
            --enable-shared \
            --disable-static \
            CFLAGS="${BASE_CFLAGS}" \
            CXXFLAGS="${BASE_CXXFLAGS}" \
            CPPFLAGS="${BASE_CPPFLAGS} -DSQLITE_ENABLE_COLUMN_METADATA -DSQLITE_ENABLE_RTREE" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "sqlite make" make -j$(nproc)
          run "sqlite install" make install

          cd "${PREFIX}" || exit 1

          echo "== Strip exe / dll =="
          find . -type f \( -name '*.exe' -o -name '*.dll' \) -print0 |
            xargs -0 -n1 "${CROSS_PREFIX}/bin/${TARGET}-strip" --strip-unneeded || true

          echo "== Strip static libraries =="
          find . -type f -name '*.a' -print0 |
            xargs -0 -n1 "${CROSS_PREFIX}/bin/${TARGET}-strip" --strip-debug || true

          echo "== Remove libtool artifacts =="
          find . -type f -name '*.la' -delete

          echo "== Remove stray debug files (if any) =="
          find . -type f -name '*.debug' -delete

      - name: upload logs
        if: always() || cancelled() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-logs
          path: "${{ github.workspace }}/logs"

      - name: upload native toolchain
        uses: actions/upload-artifact@v4
        with:
          name: mingw-w64-native-toolchain-linux
          path: "${{ github.workspace }}/mingw-w64-native"

  build-Extension-components:
    needs: build-cross
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download mingw-w64-native-toolchain
        uses: actions/download-artifact@v4
        with:
          name: mingw-w64-native-toolchain-linux
          path: "${{ github.workspace }}/mingw-w64-native"
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
           base-devel
           lndir git
           subversion
           tar zip p7zip
           make patch
           automake autoconf
           autoconf-archive
           libtool flex bison
           gettext gettext-devel
           wget sshpass
           texinfo autogen
           dejagnu pkgconf
           jq coreutils pkg-config

      - name: download source code
        shell: msys2 {0}
        env:
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          GITHUB_WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${SOURCE_CODE_DIR}" "${LOG_DIR}"
          GNU_BASE_URL="https://ftp.gnu.org/gnu"
          GITHUB_BASE_URL="https://github.com"
          SQLITE_BASE_URL="https://sqlite.org"

          source "${GITHUB_WORKSPACE}/scripts/functions.sh"
          export_versions_from_json "${GITHUB_WORKSPACE}/dependencies.json" ${GCC_VERSION} local

          gnu_pkgs=( make gdb )
          github_pkgs=( ninja cmake pkgconf )
          git_clone_pkgs=( python )

          for p in "${gnu_pkgs[@]}"; do
            p_val=${p^^}
            URL="${GNU_BASE_URL}/${p}/${p}-${!p_val}.tar.gz"
            run "下载 ${p} 源码" curl_download ${URL} "${SOURCE_CODE_DIR}"
            run "解压 ${p} 源码" archive_extract ${p} "${SOURCE_CODE_DIR}/${p}-${!p_val}.tar.gz" ${SOURCE_CODE_DIR}
          done
          for p in "${github_pkgs[@]}";do
            case "${p}" in
              pkgconf)
                pkg_name=${p^^}
                ver="${!pkg_name}"
                github_author="${p}"
                project_name="${p}"
                ;;
              ninja)
                ver="${NINJA}"
                github_author="ninja-build"
                project_name="ninja"
                ;;
              cmake)
                ver="${CMAKE}"
                github_author="Kitware"
                project_name="CMake"
                ;;
              *)
                error "未知的 GitHub 包: ${p}"
                exit 1
                ;;
            esac
            if [[ "${p}" == "pkgconf" ]] || [[ "${p}" == "cmake" ]]; then
              tail="${p}-${ver}.tar.gz"
            else
              tail="v${ver}.tar.gz" # cpython-mingw zlib ninja
            fi
            if [[ "${p}" == "cmake" ]]; then
              TAG="v${ver}"
              URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/releases/download/${TAG}/${tail}"
            # elif [[ "${p}" == "expat" ]]; then
            #   EXPAT_TAG="R_${ver//./_}"
            #   URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/releases/download/${EXPAT_TAG}/${tail}"
            else
              URL="${GITHUB_BASE_URL}/${github_author}/${project_name}/archive/refs/tags/${tail}"
            fi
            run "下载${p}-${ver} 源码" curl_download "${URL}" "${SOURCE_CODE_DIR}"
            run "解压${p}-${ver} 源码" archive_extract "${p}" "${SOURCE_CODE_DIR}/${tail}" "${SOURCE_CODE_DIR}"
          done
          # run "下载 sqlite 源码" curl_download "${SQLITE_BASE_URL}/${SQLITE_YEAR}/sqlite-autoconf-${SQLITE_VERSION}.tar.gz" "${SOURCE_CODE_DIR}"
          # run "解压 sqlite 源码" archive_extract sqlite "${SOURCE_CODE_DIR}/sqlite-autoconf-${SQLITE_VERSION}.tar.gz" "${SOURCE_CODE_DIR}"

          run "git clone cpython-mingw source code" git clone -b mingw-v${PYTHON} https://github.com/msys2-contrib/cpython-mingw.git "${SOURCE_CODE_DIR}/python"

          ls -l "${SOURCE_CODE_DIR}"

      - name: build Extension components
        shell: msys2 {0}
        env:
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          GITHUB_WORKSPACE=$(cygpath -u "${{ github.workspace }}")
          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export BUILD_DIR="${GITHUB_WORKSPACE}/build"
          export PREFIX="${GITHUB_WORKSPACE}/mingw-w64-native"
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${BUILD_DIR}" "${LOG_DIR}"

          export PATH="${PREFIX}/bin:${PATH}"

          export BUILD="x86_64-w64-mingw32"
          export HOST="x86_64-w64-mingw32"
          export TARGET="x86_64-w64-mingw32"

          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          export TARGET_DIR="${PREFIX}/${TARGET}"
          export OPT_DIR="${PREFIX}/opt"

          export BASE_CFLAGS="-O2 -pipe -fno-ident -I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_CXXFLAGS="-O2 -pipe -fno-ident -I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_CPPFLAGS="-I${TARGET_DIR}/include -I${OPT_DIR}/include"
          export BASE_LDFLAGS="-L${TARGET_DIR}/lib -L${OPT_DIR}/lib"

          # build python ${OPT_DIR}
          unset TARGET
          run "准备python build dir" mkdir -p "${BUILD_DIR}/python-build"
          cd "${SOURCE_CODE_DIR}/python" && autoreconf -fi
          cd "${BUILD_DIR}/python-build"
          run "python configure" bash -c '
            CURSES_CFLAGS="-I${OPT_DIR}/include/ncursesw" \
            CURSES_LIBS="-L${OPT_DIR}/lib -lncursesw" \
            "${SOURCE_CODE_DIR}/python/configure" \
            --build=x86_64-w64-mingw32 \
            --host=x86_64-w64-mingw32 \
            --prefix=${OPT_DIR} \
            --enable-shared \
            --enable-loadable-sqlite-extensions \
            --without-ensurepip \
            --without-c-locale-coercion \
            --with-system-expat \
          CFLAGS="${BASE_CFLAGS} -Wno-error=implicit-function-declaration -I${OPT_DIR}/include/ncursesw -U_UCRT -D__USE_MINGW_ANSI_STDIO=1 -DNCURSES_STATIC" \
          CXXFLAGS="${BASE_CXXFLAGS}" \
          CPPFLAGS="${BASE_CPPFLAGS} -Wno-error=implicit-function-declaration -I${OPT_DIR}/include/ncursesw -U_UCRT -D__USE_MINGW_ANSI_STDIO=1 -DNCURSES_STATIC" \
          LDFLAGS="${BASE_LDFLAGS}" \
          OPENSSL_LIBS="-lcrypto -lssl"'

          run "python make" make -j$(nproc)
          run "python install" make install

          # build gdb ${PREFIX}
          export TARGET="x86_64-w64-mingw32"
          run "准备gdb build dir" mkdir -p "${BUILD_DIR}/gdb-build"
          cd "${BUILD_DIR}/gdb-build"
          run "gdb configure" "${SOURCE_CODE_DIR}/gdb/configure" \
            --build="${BUILD}" \
            --host="${HOST}" \
            --target="${TARGET}" \
            --prefix="${PREFIX}" \
            --enable-shared \
            --with-python="${OPT_DIR}/bin/python3.exe" \
            --with-expat \
            --with-libiconv="${PREFIX}" \
            --with-zlib --enable-tui --disable-gdbtk \
            --enable-64-bit-bfd --disable-nls \
            --disable-werror --disable-win32-registry \
            --disable-rpath --with-system-gdbinit="${PREFIX}/etc/gdbinit" \
            CFLAGS="${BASE_CFLAGS} -I${OPT_DIR}/include/ncursesw -D__USE_MINGW_ANSI_STDIO=1 -fcommon -DNCURSES_STATIC -D_WIN32_WINNT=0x0601" \
            CXXFLAGS="${BASE_CXXFLAGS} -I${OPT_DIR}/include/ncursesw -D__USE_MINGW_ANSI_STDIO=1 -DNCURSES_STATIC -D_WIN32_WINNT=0x0601" \
            CPPFLAGS="${BASE_CPPFLAGS} -I${OPT_DIR}/include/ncursesw -D__USE_MINGW_ANSI_STDIO=1 -DNCURSES_STATIC -D_WIN32_WINNT=0x0601" \
            LDFLAGS="${BASE_LDFLAGS}"
          run "gdb make" make -j$(nproc)
          run "gdb install" make install

          # build make ${PREFIX}

          # build cmake ${PREFIX}

          # build pkgconf ${PREFIX}

          # build ninja ${PREFIX}

          run "删除多余链接目录" rm -rf "${TARGET_DIR}/mingw"

          cd "${PREFIX}" || exit 1

          echo "== Strip exe / dll =="
          find . -type f \( -name '*.exe' -o -name '*.dll' \) -print0 |
            xargs -0 -n1 "${CROSS_PREFIX}/bin/${TARGET}-strip" --strip-unneeded || true

          echo "== Strip static libraries =="
          find . -type f -name '*.a' -print0 |
            xargs -0 -n1 "${CROSS_PREFIX}/bin/${TARGET}-strip" --strip-debug || true

          echo "== Remove libtool artifacts =="
          find . -type f -name '*.la' -delete

          echo "== Remove stray debug files (if any) =="
          find . -type f -name '*.debug' -delete

      - name: upload logs
        if: always() || cancelled() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-msys2-logs
          path: "${{ github.workspace }}/logs"

      - name: upload native toolchain
        uses: actions/upload-artifact@v4
        with:
          name: mingw-w64-native-toolchain-msys2
          path: "${{ github.workspace }}/mingw-w64-native"
