name: Test get version of dependencies

on:
  workflow_dispatch:
    inputs:
      gcc-version:
        description: 'GCC Version'
        required: true
        default: '13.2.0'

jobs:
  build-cross:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install System dependencies
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          FORCE_COLOR: '1'
        run: |
          set -euo pipefail

          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          mkdir -p "${LOG_DIR}"
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          info "开始安装系统依赖（apt-get）"

          run "apt-get update" sudo apt-get update

          pkgs="git wget tar jq base64"

          run "apt-get install packages" bash -lc 'sudo DEBIAN_FRONTEND=noninteractive apt-get install -y '"$pkgs"

          info "系统依赖安装完成"

      - name: Get Dependencies Version
        id: get-versions
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
          DEP_ISON_FILE: "${{ github.workspace }}/dependencies.json"
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"
          info "GCC 版本: ${GCC_VERSION}"
          run "获取组件版本信息" export_versions_from_json "${DEP_ISON_FILE}" "${GCC_VERSION}" env

      - name: Print Dependencies Version
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          set -euo pipefail
          source "${GITHUB_WORKSPACE}/scripts/functions.sh"

          # optional tuning
          export LOG_DIR="${GITHUB_WORKSPACE}/logs"
          export FORCE_COLOR=1
          mkdir -p "${LOG_DIR}"
          IGNORE_REGEX='array subscript 0 is outside array bounds'
          LOG_TAIL_LINES=80
          FAIL_ON_FATAL_IN_SUCCESS=1

          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          mkdir -p "${SOURCE_CODE_DIR}" "${GITHUB_WORKSPACE}/logs"
          export -f _curl_download get_version sqlite_digits download_by_name

          pkgs=( gcc binutils mingw-w64 libiconv zlib libgnurx bzip2 make termcap libffi expat ncurses readline gdbm openssl tcl tk python xz sqlite gdb )
          for pkg in "${pkgs[@]}"; do
            run "下载 ${pkg}" bash -lc "download_by_name ${pkg} > \"${GITHUB_WORKSPACE}/logs/download_${pkg}.path\" || exit 1"
            # 读取路径（如果需要在同步脚本里进一步处理）
            dlpath="$(cat "${GITHUB_WORKSPACE}/logs/download_${pkg}.path" 2>/dev/null || true)"
            info "Downloaded ${pkg} -> ${dlpath:-<missing>}"
          done

          ls -lah "${SOURCE_CODE_DIR}"
