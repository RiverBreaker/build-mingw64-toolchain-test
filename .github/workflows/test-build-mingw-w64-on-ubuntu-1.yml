name: Test Build Mingw-w64 on Ubuntu(1)

on:
  workflow_dispatch:
    inputs:
      gcc-version:
        description: 'GCC Version'
        required: true
        default: '13.2.0'

jobs:
  build-cross:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install System dependencies
        shell: bash
        run: |
          echo "sudo apt-get update"
          sudo apt-get update 2>&1
          echo "sudo apt-get install -y build-essential autoconf automake libtool pkg-config flex bison texinfo lzma-dev zlib1g-dev nasm libgmp-dev libmpfr-dev libmpc-dev libisl-dev git wget tar xz-utils"
          sudo apt-get install -y \
            build-essential autoconf automake \
            libtool pkg-config flex bison texinfo \
            lzma-dev zlib1g-dev nasm \
            libgmp-dev libmpfr-dev libmpc-dev libisl-dev \
            git wget tar xz-utils \
            2>&1

      - name: Download Source Code
        shell: bash
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GCC_VERSION: ${{ github.event.inputs.gcc-version }}
        run: |
          export SOURCE_CODE_DIR="${GITHUB_WORKSPACE}/source-code"
          export MINGW_BASE_URL="https://sourceforge.net/projects/mingw-w64/files/mingw-w64/mingw-w64-release"
          export GNU_BASE_URL="https://ftp.gnu.org/gnu"

          mkdir -p "${SOURCE_CODE_DIR}"
          echo "Downloading source code to ${SOURCE_CODE_DIR}"
          # 下载gcc源码
          curl -sSL "${GNU_BASE_URL}/gcc/gcc-${GCC_VERSION}/gcc-${GCC_VERSION}.tar.gz" -o "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz"
          # 下载binutils源码
          curl -sSL "${GNU_BASE_URL}/binutils/binutils-2.40.tar.gz" -o "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz"
          # 下载mingw-w64源码
          curl -sSL "${MINGW_BASE_URL}/mingw-w64-v11.0.1.tar.bz2/download" -o "${SOURCE_CODE_DIR}/mingw-w64-v11.0.1.tar.bz2"

          echo "解压源码包"
          tar -xf "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz" -C "${SOURCE_CODE_DIR}/" \
          && rm -rf "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}.tar.gz"
          tar -xf "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz" -C "${SOURCE_CODE_DIR}/" \
          && rm -rf "${SOURCE_CODE_DIR}/binutils-2.40.tar.gz"
          tar -xf "${SOURCE_CODE_DIR}/mingw-w64-v11.0.1.tar.bz2" -C "${SOURCE_CODE_DIR}/" \
          && rm -rf "${SOURCE_CODE_DIR}/mingw-w64-v11.0.1.tar.bz2"
          echo "解压完成"
          # 后续操作
          mv "${SOURCE_CODE_DIR}/gcc-${GCC_VERSION}" "${SOURCE_CODE_DIR}/gcc"
          mv "${SOURCE_CODE_DIR}/binutils-2.40" "${SOURCE_CODE_DIR}/binutils"
          mv "${SOURCE_CODE_DIR}/mingw-w64-v11.0.1" "${SOURCE_CODE_DIR}/mingw-w64"
          cd "${SOURCE_CODE_DIR}/gcc"
          ./contrib/download_prerequisites --directory="${SOURCE_CODE_DIR}"

          # 清理 gcc 目录中的依赖目录（如果有的话）
          for d in gmp mpfr mpc isl; do
            if [ -d "${SOURCE_CODE_DIR}/gcc/$d" ]; then
              echo "删除 ${SOURCE_CODE_DIR}/gcc/$d"
              rm -rf "${SOURCE_CODE_DIR}/gcc/$d"
            fi
          done
          cd "${SOURCE_CODE_DIR}"
          # 删除可能存在的压缩包文件
          for f in gmp-*.tar.* mpfr-*.tar.* mpc-*.tar.* isl-*.tar.*; do
            if [ -f "${SOURCE_CODE_DIR}/$f" ]; then
              echo "删除压缩包 ${SOURCE_CODE_DIR}/$f"
              rm -f "${SOURCE_CODE_DIR}/$f"
            fi
          done
          for name in gmp mpfr mpc isl; do
            # 查找以该名称开头的目录（去掉版本号）
            # 使用shopt -s nullglob防止在没有匹配时返回通配符本身
            shopt -s nullglob
            dirs=(${name}-*/)
            shopt -u nullglob

            if [ ${#dirs[@]} -gt 0 ] && [ -d "${dirs[0]}" ]; then
              dir="${dirs[0]%/}"  # 去除结尾的斜杠
              echo "重命名 $dir 为 $name"
              rm -rf "$name" 2>/dev/null || true
              mv "${SOURCE_CODE_DIR}/$dir" "$name"
            else
              echo "警告: 未找到 $name-* 目录"
            fi
          done

          ls -la "${SOURCE_CODE_DIR}"
          echo "ls -la ${SOURCE_CODE_DIR}/gcc"
          ls -la "${SOURCE_CODE_DIR}/gcc"





